<!doctype html><html><!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><meta charset=utf-8><meta name=generator content="Hugo 0.154.4"><meta name=viewport content="width=device-width,initial-scale=1"><title>PHP反序列化漏洞总结 &#183; Wat4r Blog</title><meta name=description content><link rel=stylesheet href=/sass/water.min.css><link type=text/css rel=stylesheet href=https://wat4r.github.io/css/all.min.css><link type=text/css rel=stylesheet href=https://wat4r.github.io/css/dracula.css><link rel="shortcut icon" href=https://wat4r.github.io/images/favicon.ico></head><body><header><nav class=post-nav role=navigation><a href=/>‹ All Posts</a></nav></header><main class="container post-page"><article class=article><h1 class=post-title>PHP反序列化漏洞总结</h1><aside class=toc><nav id=TableOfContents><ul><li><a href=#0x01-简介>0x01 简介</a><ul><li><a href=#1-序列化serialize>1. 序列化（serialize）</a></li><li><a href=#2-反序列化unserialize>2. 反序列化（unserialize）</a></li></ul></li><li><a href=#0x02-序列化格式>0x02 序列化格式</a></li><li><a href=#0x03-publicprivate与protect类型>0x03 public、private与protect类型</a><ul><li><a href=#public属性>public属性</a></li><li><a href=#private属性>private属性</a></li><li><a href=#protected属性>protected属性</a></li><li><a href=#序列化长度问题>序列化长度问题</a></li></ul></li><li><a href=#0x04-魔术方法>0x04 魔术方法</a><ul><li><a href=#简介>简介</a></li><li><a href=#__construct>__construct()</a></li><li><a href=#__destruct>__destruct()</a></li><li><a href=#__tostring>__toString()</a></li><li><a href=#__call>__call()</a></li><li><a href=#__callstatic>__callStatic()</a></li><li><a href=#__invoke>__invoke()</a></li><li><a href=#__wakeup>__wakeup()</a></li><li><a href=#__get>__get()</a></li><li><a href=#__set>__set()</a></li><li><a href=#__isset>__isset()</a></li><li><a href=#__unset>__unset()</a></li><li><a href=#__sleep>__sleep()</a></li></ul></li><li><a href=#0x05-绕过方法>0x05 绕过方法</a><ul><li><a href=#绕过__wakeupcve-2016-7124>绕过__wakeup(CVE-2016-7124)</a></li><li><a href=#引用绕过>引用绕过</a></li><li><a href=#16进制绕过字符的过滤>16进制绕过字符的过滤</a></li><li><a href=#php71反序列化对类属性不敏感>PHP7.1+反序列化对类属性不敏感</a></li><li><a href=#绕过部分正则>绕过部分正则</a></li></ul></li><li><a href=#0x06-限制>0x06 限制</a></li><li><a href=#0x07-工具>0x07 工具</a><ul><li><a href=#phpggcphp通用小工具链>PHPGGC：PHP通用小工具链</a></li></ul></li><li><a href=#0x08-反序列化漏洞>0x08 反序列化漏洞</a><ul><li><a href=#介绍>介绍</a></li><li><a href=#利用链pop-chain>利用链（POP Chain）</a></li></ul></li></ul></nav></aside><hr><h1 id=php反序列化漏洞总结>PHP反序列化漏洞总结</h1><h2 id=0x01-简介>0x01 简介</h2><p>PHP 的序列化（Serialization）和反序列化（Unserialization）是将 PHP 数据结构（如数组、对象等）转换为字符串格式，以及将该字符串还原回原始数据结构的过程。</p><h3 id=1-序列化serialize>1. 序列化（serialize）</h3><p><strong>作用</strong>：将 PHP 变量（如数组、对象、标量等）转换成一个可存储或传输的字符串表示形式。
<strong>函数</strong>：<code>serialize($value)</code>
<strong>示例</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nv>$data</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;name&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;Alice&#39;</span><span class=p>,</span> <span class=s1>&#39;age&#39;</span> <span class=o>=&gt;</span> <span class=mi>30</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=nv>$serialized</span> <span class=o>=</span> <span class=nx>serialize</span><span class=p>(</span><span class=nv>$data</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nv>$serialized</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>// 输出：a:2:{s:4:&#34;name&#34;;s:5:&#34;ALICE&#34;;s:3:&#34;age&#34;;i:30;}
</span></span></span></code></pre></div><p>这个字符串包含了类型、长度和值的信息，可以保存到文件、数据库或通过网络传输。</p><h3 id=2-反序列化unserialize>2. 反序列化（unserialize）</h3><p><strong>作用</strong>：将序列化后的字符串还原为原来的 PHP 变量。
<strong>函数</strong>：<code>unserialize($str)</code>
<strong>示例</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nv>$serialized</span> <span class=o>=</span> <span class=s1>&#39;a:2:{s:4:&#34;name&#34;;s:5:&#34;Alice&#34;;s:3:&#34;age&#34;;i:30;}&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$data</span> <span class=o>=</span> <span class=nx>unserialize</span><span class=p>(</span><span class=nv>$serialized</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>print_r</span><span class=p>(</span><span class=nv>$data</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// 输出：
</span></span></span><span class=line><span class=cl><span class=c1>// Array
</span></span></span><span class=line><span class=cl><span class=c1>// (
</span></span></span><span class=line><span class=cl><span class=c1>//     [name] =&gt; Alice
</span></span></span><span class=line><span class=cl><span class=c1>//     [age] =&gt; 30
</span></span></span><span class=line><span class=cl><span class=c1>// )
</span></span></span></code></pre></div><h2 id=0x02-序列化格式>0x02 序列化格式</h2><p>其中php_serialize的实现在 <code>php-src/ext/standard/var.c</code> 中，主要函数为 <code>php_var_serialize_intern</code> ，序列化后的格式如下：</p><ul><li>boolean<ul><li><code>b:&lt;value>;</code></li><li><code>b:1;</code> // true</li><li><code>b:0;</code> // false</li></ul></li><li>integer<ul><li><code>i:&lt;value>;</code></li><li><code>i:66</code></li></ul></li><li>double<ul><li><code>d:&lt;value>;</code></li><li><code>d:66.88</code></li></ul></li><li>null<ul><li><code>N;</code></li></ul></li><li>string<ul><li><code>s:&lt;length>:"&lt;value>";</code></li><li><code>s:1:"s";</code></li></ul></li><li>array<ul><li><code>a:&lt;length>:{key, value};</code></li><li><code>a:1:{s:4:"key1";s:6:"value1";}</code> &lt;==> <code>array("key1" => "value1");</code></li></ul></li><li>object<ul><li><code>O:&lt;class_name_length>:"&lt;class_name>":&lt;number_of_properties>:{&lt;properties>};</code></li></ul></li><li>reference<ul><li>指针类型</li><li><code>R:reference;</code></li><li><code>O:1:"A":2:{s:1:"a";i:1;s:1:"b";R:2;}</code></li><li><code>$a = new A();$a->a=1;$a->b=&$a->a;</code></li></ul></li></ul><h2 id=0x03-publicprivate与protect类型>0x03 public、private与protect类型</h2><p>private与protect变量和public变量不同，在序列化时字段名称不一样。</p><h3 id=public属性>public属性</h3><p>public属性在序列化时不需要添加额外的说明。</p><h3 id=private属性>private属性</h3><p>private属性只能在其被定义的类内部访问，且不会被继承，在属性前加上类名，即 <code>%00className%00</code> 用于标定其是私有的。</p><h3 id=protected属性>protected属性</h3><p>protected属性可以在父类和子类中访问，变量前添加 <code>%00*%00</code> 用于标定其是受保护的。</p><h3 id=序列化长度问题>序列化长度问题</h3><p>php序列化属性值时，如果是private或者protected会自动在类名两边添加一个空字节，如果是url编码用%00，如果是ASCII编码用\00，都是表示一个空字节。</p><ol><li><code>%00User%00sex</code> 表示 private</li><li><code>%00*%00money</code> 表示 protected</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Test</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=nv>$sex</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>protected</span> <span class=nv>$money</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span><span class=nv>$name</span><span class=p>,</span> <span class=nv>$sex</span><span class=p>,</span> <span class=nv>$money</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>name</span> <span class=o>=</span> <span class=nv>$name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>sex</span> <span class=o>=</span> <span class=nv>$sex</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>money</span> <span class=o>=</span> <span class=nv>$money</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$test</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Test</span><span class=p>(</span><span class=s2>&#34;test&#34;</span><span class=p>,</span> <span class=k>true</span><span class=p>,</span> <span class=mi>188</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nx>serialize</span><span class=p>(</span><span class=nv>$test</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// O:4:&#34;Test&#34;:3:{s:4:&#34;name&#34;;s:4:&#34;test&#34;;s:9:&#34;%00Test%00sex&#34;;b:1;s:8:&#34;%00*%00money&#34;;i:188;}
</span></span></span></code></pre></div><h2 id=0x04-魔术方法>0x04 魔术方法</h2><h3 id=简介>简介</h3><table><thead><tr><th style=text-align:center>魔术方法</th><th style=text-align:center>介绍</th><th style=text-align:center>自动调用</th></tr></thead><tbody><tr><td style=text-align:center><a href=#__construct><code>__construct()</code></a></td><td style=text-align:center>当一个对象创建时被调用，反序列化不触发</td><td style=text-align:center>序列化时自动调用</td></tr><tr><td style=text-align:center><a href=#__destruct><code>__destruct()</code></a></td><td style=text-align:center>当一个对象销毁时被调用，反序列化自动调用</td><td style=text-align:center>反序列化时自动调用</td></tr><tr><td style=text-align:center><a href=#__toString><code>__toString()</code></a></td><td style=text-align:center>当一个对象被当作一个字符串使用时触发</td><td style=text-align:center>✕</td></tr><tr><td style=text-align:center><a href=#__call><code>__call()</code></a></td><td style=text-align:center>在对象上下文中调用不可访问的方法时触发</td><td style=text-align:center>✕</td></tr><tr><td style=text-align:center><a href=#__callStatic><code>__callStatic()</code></a></td><td style=text-align:center>在静态上下文中调用不可访问的方法时触发</td><td style=text-align:center>✕</td></tr><tr><td style=text-align:center><a href=#__invoke><code>__invoke()</code></a></td><td style=text-align:center>当一个对象被当作函数调用时触发</td><td style=text-align:center>✕</td></tr><tr><td style=text-align:center><a href=#__wakeup><code>__wakeup()</code></a></td><td style=text-align:center>执行反序列化时，先会调用这个函数</td><td style=text-align:center>反序列化时自动调用</td></tr><tr><td style=text-align:center><a href=#__get><code>__get()</code></a></td><td style=text-align:center>从类中私有或不存的属性读取数据时触发</td><td style=text-align:center>✕</td></tr><tr><td style=text-align:center><a href=#__set><code>__set()</code></a></td><td style=text-align:center>给类中私有或不存的属性写入数据时触发</td><td style=text-align:center>✕</td></tr><tr><td style=text-align:center><a href=#__isset><code>__isset()</code></a></td><td style=text-align:center>在私有或不存的属性上调用 <code>isset()</code> 或 <code>empty()</code> 触发</td><td style=text-align:center>✕</td></tr><tr><td style=text-align:center><a href=#__unset><code>__unset()</code></a></td><td style=text-align:center>在私有或不存的属性上调用 <code>unset()</code> 时触发</td><td style=text-align:center>✕</td></tr><tr><td style=text-align:center><a href=#__sleep><code>__sleep()</code></a></td><td style=text-align:center>序列化时自动触发</td><td style=text-align:center>序列化时自动调用</td></tr></tbody></table><h3 id=__construct>__construct()</h3><ul><li><p><code>__construct()</code> 方法是类的构造方法，当一个对象创建时被自动调用，通常用于<strong>创建新对象时的初始化</strong>（比如分配资源、连接数据库等）</p></li><li><p>当对一个对象进行反序列化（<code>unserialize()</code>）时，PHP 不会自动调用 <code>__construct()</code> 方法。</p></li><li><p>反序列化是<strong>恢复已有状态</strong>，不是“新建”，所以不应重复执行构造逻辑。</p></li><li><p>示例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Test</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span><span class=nv>$name</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>name</span> <span class=o>=</span> <span class=nv>$name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s2>&#34;call __construct()&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>serialize</span><span class=p>(</span><span class=k>new</span> <span class=nx>Test</span><span class=p>(</span><span class=s2>&#34;test&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=c1>// call __construct()
</span></span></span></code></pre></div></li></ul><h3 id=__destruct>__destruct()</h3><ul><li><p><code>__destruct()</code> 方法在对象被销毁时<strong>自动调用</strong>，常用于执行清理工作，如关闭文件句柄、释放资源、记录日志等。</p></li><li><p>在反序列化（<code>unserialize()</code>）时，PHP 会自动调用 <code>__destruct()</code> 方法。</p></li><li><p>示例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Test</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__destruct</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s2>&#34;call __destruct()&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>unserialize</span><span class=p>(</span><span class=s1>&#39;O:4:&#34;Test&#34;:1:{s:4:&#34;name&#34;;s:4:&#34;test&#34;;}&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// call __destruct()
</span></span></span></code></pre></div></li></ul><h3 id=__tostring>__toString()</h3><ul><li><p><code>__toString()</code> 方法用于定义<strong>当对象被当作字符串使用时</strong>应如何转换为字符串。</p></li><li><p>在反序列化（<code>unserialize()</code>）时，PHP 不会自动调用 <code>__toString()</code> 方法。</p></li><li><p>触发场景</p></li></ul><table><thead><tr><th style=text-align:center>场景</th><th style=text-align:center>示例</th></tr></thead><tbody><tr><td style=text-align:center>使用 <code>echo</code> 或 <code>print</code> 输出对象</td><td style=text-align:center>echo $obj;</td></tr><tr><td style=text-align:center>字符串拼接</td><td style=text-align:center>&ldquo;Hello " . $obj;</td></tr><tr><td style=text-align:center>在双引号字符串中嵌入对象</td><td style=text-align:center>&ldquo;User: $obj&rdquo;;</td></tr><tr><td style=text-align:center>显式类型转换</td><td style=text-align:center>(string) $obj;</td></tr><tr><td style=text-align:center>传递给期望字符串的函数（PHP 8.0+）</td><td style=text-align:center><code>strlen($obj)</code>（不推荐，但可行）</td></tr></tbody></table><p>✅ 注意：<code>var_dump($obj)</code>、<code>print_r($obj)</code>、<code>json_encode($obj)</code> <strong>不会</strong>调用 <code>__toString()</code>。</p><ul><li><p>示例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Test</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__toString</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s2>&#34;call __toString()&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$obj</span> <span class=o>=</span> <span class=nx>unserialize</span><span class=p>(</span><span class=s1>&#39;O:4:&#34;Test&#34;:1:{s:4:&#34;name&#34;;s:4:&#34;test&#34;;}&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nv>$obj</span><span class=p>;</span> <span class=c1>// call __toString()
</span></span></span><span class=line><span class=cl><span class=nv>$b</span> <span class=o>=</span> <span class=nv>$obj</span> <span class=o>.</span> <span class=s1>&#39;a&#39;</span><span class=p>;</span> <span class=c1>// call __toString()
</span></span></span><span class=line><span class=cl><span class=nv>$c</span> <span class=o>=</span> <span class=s2>&#34;Test: </span><span class=si>$obj</span><span class=s2>&#34;</span><span class=p>;</span> <span class=c1>// call __toString()
</span></span></span><span class=line><span class=cl><span class=nv>$d</span> <span class=o>=</span> <span class=p>(</span><span class=nx>string</span><span class=p>)</span> <span class=nv>$obj</span><span class=p>;</span> <span class=c1>// call __toString()
</span></span></span></code></pre></div></li></ul><h3 id=__call>__call()</h3><ul><li><p><code>__call()</code> 方法用于<strong>拦截对不存在（或不可访问）的非静态方法的调用</strong>。它能让你动态处理方法调用，实现灵活的 API 设计、代理模式、链式调用等高级功能。</p></li><li><p>示例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Test</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__call</span><span class=p>(</span><span class=nv>$method</span><span class=p>,</span> <span class=nv>$args</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s2>&#34;call </span><span class=si>{</span><span class=nv>$method</span><span class=si>}</span><span class=s2>(</span><span class=si>{</span><span class=nv>$args</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=si>}</span><span class=s2>)&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$obj</span> <span class=o>=</span> <span class=nx>unserialize</span><span class=p>(</span><span class=s1>&#39;O:4:&#34;Test&#34;:1:{s:4:&#34;name&#34;;s:4:&#34;test&#34;;}&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$obj</span><span class=o>-&gt;</span><span class=na>test</span><span class=p>(</span><span class=mi>123</span><span class=p>);</span> <span class=c1>// call test(123)
</span></span></span></code></pre></div></li></ul><h3 id=__callstatic>__callStatic()</h3><ul><li><p><code>__callStatic()</code> 方法用于<strong>拦截对不存在（或不可访问）的静态方法的调用</strong>。它是 <code>__call()</code> 的静态版本，专为类（而非对象实例）设计。</p></li><li><p><code>unserialize()</code> 不会调用 <code>__callStatic()</code>，<strong>反序列化是对象重建过程</strong>，不涉及“调用静态方法”。</p></li><li><p>示例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Test</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>static</span> <span class=k>function</span> <span class=fm>__callStatic</span><span class=p>(</span><span class=nv>$method</span><span class=p>,</span> <span class=nv>$args</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s2>&#34;call </span><span class=si>{</span><span class=nv>$method</span><span class=si>}</span><span class=s2>(</span><span class=si>{</span><span class=nv>$args</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=si>}</span><span class=s2>)&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>Test</span><span class=o>::</span><span class=na>test</span><span class=p>(</span><span class=mi>123</span><span class=p>);</span> <span class=c1>// call test(123)
</span></span></span></code></pre></div></li></ul><h3 id=__invoke>__invoke()</h3><ul><li><p><code>__invoke()</code> 方法在当一个对象被当作函数调用时触发。</p></li><li><p>在反序列化（unserialize）的上下文中，<code>__invoke()</code> <strong>本身不会被自动触发</strong>，但在特定条件下（如与其他魔术方法结合），它可以成为反序列化漏洞利用链（gadget chain）中的关键一环。</p></li><li><p>通过其它魔术方法调用 <code>$this();</code> 也可以触发<code>__invoke()</code></p></li><li><p>示例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Test</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__invoke</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s2>&#34;call __invoke()&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__destruct</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$obj</span> <span class=o>=</span> <span class=nx>unserialize</span><span class=p>(</span><span class=s1>&#39;O:4:&#34;Test&#34;:1:{s:4:&#34;name&#34;;N;}&#39;</span><span class=p>);</span> <span class=c1>// call __invoke()
</span></span></span><span class=line><span class=cl><span class=nv>$obj</span><span class=p>();</span> <span class=c1>// call __invoke()
</span></span></span></code></pre></div></li></ul><h3 id=__wakeup>__wakeup()</h3><ul><li><p><code>__wakeup()</code> 方法在对象被 <strong>反序列化（unserialize）时首先被自动调用</strong>。它主要用于<strong>恢复对象状态</strong>，但由于其自动执行的特性，也成为<strong>反序列化漏洞（Unserialize RCE）中常见的入口点之一</strong>。</p></li><li><p>示例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Test</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__wakeup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s2>&#34;call __wakeup()&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$obj</span> <span class=o>=</span> <span class=nx>unserialize</span><span class=p>(</span><span class=s1>&#39;O:4:&#34;Test&#34;:1:{s:4:&#34;name&#34;;N;}&#39;</span><span class=p>);</span> <span class=c1>// call __wakeup()
</span></span></span></code></pre></div></li></ul><h3 id=__get>__get()</h3><ul><li><p><code>__get()</code> 方法在当访问一个<strong>未定义的属性</strong>或访问一个**不可访问的属性（private或protected类型）**时自动调用。</p></li><li><p>它常用于实现延迟加载（Lazy Loading）、动态属性、代理模式等，但也因其自动调用特性，成为<strong>反序列化漏洞（Unserialize RCE）的关键利用点之一</strong>。</p></li><li><p><code>__get()</code> 必须是 public 方法，返回值即为该“虚拟属性”的值。</p></li><li><p>示例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Test</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=nv>$age</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span><span class=nv>$name</span><span class=p>,</span> <span class=nv>$age</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>name</span> <span class=o>=</span> <span class=nv>$name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>age</span> <span class=o>=</span> <span class=nv>$age</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=nf>getName</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__get</span><span class=p>(</span><span class=nv>$name</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s2>&#34;call __get()&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=nv>$name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$obj</span> <span class=o>=</span> <span class=nx>unserialize</span><span class=p>(</span><span class=nx>serialize</span><span class=p>(</span><span class=k>new</span> <span class=nx>Test</span><span class=p>(</span><span class=s2>&#34;Dog&#34;</span><span class=p>,</span> <span class=mi>8</span><span class=p>)));</span>
</span></span><span class=line><span class=cl><span class=nv>$obj</span><span class=o>-&gt;</span><span class=na>getName</span><span class=p>();</span> <span class=c1>// 不会触发__get()
</span></span></span><span class=line><span class=cl><span class=nv>$a</span> <span class=o>=</span> <span class=nv>$obj</span><span class=o>-&gt;</span><span class=na>a</span><span class=p>;</span> <span class=c1>// call __get()
</span></span></span><span class=line><span class=cl><span class=nv>$age</span> <span class=o>=</span> <span class=nv>$obj</span><span class=o>-&gt;</span><span class=na>age</span><span class=p>;</span> <span class=c1>// call __get()
</span></span></span></code></pre></div></li></ul><h3 id=__set>__set()</h3><ul><li><p><code>__set()</code> 方法用于在给<strong>未定义的属性</strong>或**不可访问的属性（private或protected类型）**赋值时自动触发。</p></li><li><p>常用于实现动态属性、数据验证、代理模式等，但由于其自动调用特性，在反序列化场景中也可以成为<strong>利用连的跳板</strong>。</p></li><li><p>示例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Test</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=nv>$age</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span><span class=nv>$name</span><span class=p>,</span> <span class=nv>$age</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>name</span> <span class=o>=</span> <span class=nv>$name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__set</span><span class=p>(</span><span class=nv>$name</span><span class=p>,</span> <span class=nv>$value</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s2>&#34;call __set(</span><span class=si>{</span><span class=nv>$name</span><span class=si>}</span><span class=s2>, </span><span class=si>{</span><span class=nv>$value</span><span class=si>}</span><span class=s2>)&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$obj</span> <span class=o>=</span> <span class=nx>unserialize</span><span class=p>(</span><span class=nx>serialize</span><span class=p>(</span><span class=k>new</span> <span class=nx>Test</span><span class=p>(</span><span class=s2>&#34;Dog&#34;</span><span class=p>,</span> <span class=mi>8</span><span class=p>)));</span>
</span></span><span class=line><span class=cl><span class=nv>$obj</span><span class=o>-&gt;</span><span class=na>name</span> <span class=o>=</span> <span class=s2>&#34;aaa&#34;</span><span class=p>;</span> <span class=c1>// 不会调用__set()
</span></span></span><span class=line><span class=cl><span class=nv>$obj</span><span class=o>-&gt;</span><span class=na>test</span> <span class=o>=</span> <span class=s2>&#34;666&#34;</span><span class=p>;</span> <span class=c1>// call __set(test, 666)
</span></span></span><span class=line><span class=cl><span class=nv>$obj</span><span class=o>-&gt;</span><span class=na>age</span> <span class=o>=</span> <span class=s2>&#34;123&#34;</span><span class=p>;</span> <span class=c1>// call __set(age, 123)
</span></span></span></code></pre></div></li></ul><h3 id=__isset>__isset()</h3><ul><li><p><code>__isset()</code> 方法用于在对对象的**未定义的属性或不可访问属性（private或protected类型）**使用 <code>isset()</code> 或 <code>empty()</code> 时自动触发。它通常与 <code>__get()</code>、<code>__set()</code> 配合使用，以实现对动态属性的完整控制。</p></li><li><p>在复杂的反序列化利用链中，它可以作为<strong>条件判断或跳板</strong>被间接调用。</p></li><li><p><code>__isset()</code>必须是 <code>public</code> 方法</p></li><li><p>当执行 <code>isset($obj->prop)</code> 或 <code>empty($obj->prop)</code> 时，若 <code>$prop</code> 不存在或不可访问，则调用此方法。</p></li><li><p><strong>必须返回 <code>bool</code> 类型</strong>（PHP 8.0+ 严格要求）</p></li><li><p>在对象内部调用 <code>isset($obj->age)</code> 时，若 <code>$age</code> 是private或protected类型，不会触发 <code>__isset()</code></p></li><li><p>示例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Test</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=nv>$age</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span><span class=nv>$name</span><span class=p>,</span> <span class=nv>$age</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>name</span> <span class=o>=</span> <span class=nv>$name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>public</span> <span class=k>function</span> <span class=nf>test</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>isset</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>prop</span><span class=p>);</span> <span class=c1>// call __isset()
</span></span></span><span class=line><span class=cl>        <span class=nx>isset</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>age</span><span class=p>);</span> <span class=c1>// 不会调用__isset()
</span></span></span><span class=line><span class=cl>        <span class=k>empty</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>prop</span><span class=p>);</span> <span class=c1>// call __isset()
</span></span></span><span class=line><span class=cl>        <span class=k>empty</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>age</span><span class=p>);</span> <span class=c1>// call __isset()
</span></span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__isset</span><span class=p>(</span><span class=nv>$name</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s2>&#34;call __isset()&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$obj</span> <span class=o>=</span> <span class=nx>unserialize</span><span class=p>(</span><span class=nx>serialize</span><span class=p>(</span><span class=k>new</span> <span class=nx>Test</span><span class=p>(</span><span class=s2>&#34;Dog&#34;</span><span class=p>,</span> <span class=mi>8</span><span class=p>)));</span>
</span></span><span class=line><span class=cl><span class=nx>isset</span><span class=p>(</span><span class=nv>$obj</span><span class=o>-&gt;</span><span class=na>name</span><span class=p>);</span> <span class=c1>// 不会调用__isset()
</span></span></span><span class=line><span class=cl><span class=nx>isset</span><span class=p>(</span><span class=nv>$obj</span><span class=o>-&gt;</span><span class=na>prop</span><span class=p>);</span> <span class=c1>// call __isset()
</span></span></span><span class=line><span class=cl><span class=nx>isset</span><span class=p>(</span><span class=nv>$obj</span><span class=o>-&gt;</span><span class=na>age</span><span class=p>);</span> <span class=c1>// call __isset()
</span></span></span><span class=line><span class=cl><span class=k>empty</span><span class=p>(</span><span class=nv>$obj</span><span class=o>-&gt;</span><span class=na>prop</span><span class=p>);</span> <span class=c1>// call __isset()
</span></span></span><span class=line><span class=cl><span class=k>empty</span><span class=p>(</span><span class=nv>$obj</span><span class=o>-&gt;</span><span class=na>age</span><span class=p>);</span> <span class=c1>// call __isset()
</span></span></span></code></pre></div></li></ul><h3 id=__unset>__unset()</h3><ul><li><p><code>__unset()</code> 方法用于在对对象的**未定义的属性或不可访问属性（private或protected类型）**使用 <code>unset()</code> 时自动触发。它通常与 <code>__get()</code>、<code>__set()</code>、<code>__isset()</code> 配合，实现对动态属性的完整生命周期管理。</p></li><li><p>必须是 <code>public</code> 方法。</p></li><li><p>当执行 <code>unset($obj->prop)</code> 且 <code>$prop</code> 不存在或不可访问时自动调用。</p></li><li><p>常用于清理动态存储的数据（如内部数组、缓存等）。</p></li><li><p>示例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Test</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=nv>$age</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span><span class=nv>$name</span><span class=p>,</span> <span class=nv>$age</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>name</span> <span class=o>=</span> <span class=nv>$name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>age</span> <span class=o>=</span> <span class=nv>$age</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__unset</span><span class=p>(</span><span class=nv>$name</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s2>&#34;call __unset()&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$obj</span> <span class=o>=</span> <span class=nx>unserialize</span><span class=p>(</span><span class=nx>serialize</span><span class=p>(</span><span class=k>new</span> <span class=nx>Test</span><span class=p>(</span><span class=s2>&#34;Dog&#34;</span><span class=p>,</span> <span class=mi>8</span><span class=p>)));</span>
</span></span><span class=line><span class=cl><span class=nx>unset</span><span class=p>(</span><span class=nv>$obj</span><span class=o>-&gt;</span><span class=na>name</span><span class=p>);</span> <span class=c1>// 不会调用__unset()
</span></span></span><span class=line><span class=cl><span class=nx>unset</span><span class=p>(</span><span class=nv>$obj</span><span class=o>-&gt;</span><span class=na>nonExistentProp</span><span class=p>);</span> <span class=c1>// call __unset()
</span></span></span><span class=line><span class=cl><span class=nx>unset</span><span class=p>(</span><span class=nv>$obj</span><span class=o>-&gt;</span><span class=na>age</span><span class=p>);</span> <span class=c1>// call __unset()
</span></span></span></code></pre></div></li></ul><h3 id=__sleep>__sleep()</h3><ul><li><p>在使用 <a href=http://php.net/manual/zh/function.serialize.php>serialize()</a> 函数时，程序会检查类中是否存在一个 <a href=http://php.net/manual/zh/language.oop5.magic.php#object.sleep>__sleep()</a> 魔术方法，如果存在，则该方法会先被调用，然后再执行序列化操作。</p></li><li><p>示例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Test</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span><span class=nv>$name</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>name</span> <span class=o>=</span> <span class=nv>$name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__sleep</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s1>&#39;call __sleep()&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>serialize</span><span class=p>(</span><span class=k>new</span> <span class=nx>Test</span><span class=p>(</span><span class=s2>&#34;test&#34;</span><span class=p>));</span> <span class=c1>// call __sleep()
</span></span></span></code></pre></div></li></ul><h2 id=0x05-绕过方法>0x05 绕过方法</h2><h3 id=绕过__wakeupcve-2016-7124>绕过__wakeup(CVE-2016-7124)</h3><p>序列化字符串中表示对象<strong>属性个数的值大于真实的属性个数</strong>时会跳过 <code>__wakeup()</code> 的执行。</p><p>版本：</p><ul><li>PHP5 &lt; 5.6.25</li><li>PHP7 &lt; 7.0.10</li></ul><p>示例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Test</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>name</span> <span class=o>=</span> <span class=s1>&#39;ok&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__wakeup</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s2>&#34;call __wakeup()&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__destruct</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>unserialize</span><span class=p>(</span><span class=s1>&#39;O:4:&#34;Test&#34;:1:{s:4:&#34;name&#34;;s:2:&#34;ok&#34;;}&#39;</span><span class=p>);</span> <span class=c1>// call __wakeup()ok
</span></span></span></code></pre></div><p>以上执行 <code>unserialize</code> 会自动调用 <code>__wakeup()</code>，如果把<strong>属性个数从1改成2</strong>，则 <code>__wakeup()</code> 不会执行：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Test</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>name</span> <span class=o>=</span> <span class=s1>&#39;ok&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__wakeup</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s2>&#34;call __wakeup()&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__destruct</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>unserialize</span><span class=p>(</span><span class=s1>&#39;O:4:&#34;Test&#34;:2:{s:4:&#34;name&#34;;s:2:&#34;ok&#34;;}&#39;</span><span class=p>);</span> <span class=c1>// ok
</span></span></span></code></pre></div><h3 id=引用绕过>引用绕过</h3><p>利用引用使两值恒等，相当于c语言的指针，通过取地址符将a的地址给b，让b指向和a相同的内存空间，共享同一块内存，所有存储的内容是相同的，一方改变另一方内容也改变。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Test</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$a</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$b</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>a</span> <span class=o>=</span> <span class=s1>&#39;abc&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>b</span><span class=o>=</span> <span class=o>&amp;</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>a</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span>  <span class=fm>__destruct</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>a</span><span class=o>===</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>b</span><span class=p>){</span>
</span></span><span class=line><span class=cl>            <span class=k>echo</span> <span class=mi>666</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span> <span class=o>=</span> <span class=nx>serialize</span><span class=p>(</span><span class=k>new</span> <span class=nx>Test</span><span class=p>());</span> <span class=c1>// 666
</span></span></span></code></pre></div><h3 id=16进制绕过字符的过滤>16进制绕过字符的过滤</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nx>O</span><span class=o>:</span><span class=mi>4</span><span class=o>:</span><span class=s2>&#34;test&#34;</span><span class=o>:</span><span class=mi>2</span><span class=o>:</span><span class=p>{</span><span class=nx>s</span><span class=o>:</span><span class=mi>4</span><span class=o>:</span><span class=s2>&#34;%00*%00a&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>3</span><span class=o>:</span><span class=s2>&#34;abc&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>7</span><span class=o>:</span><span class=s2>&#34;%00test%00b&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>3</span><span class=o>:</span><span class=s2>&#34;def&#34;</span><span class=p>;}</span>
</span></span></code></pre></div><p>表示字符类型的s大写时，会被当成16进制解析，可以写成：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nx>O</span><span class=o>:</span><span class=mi>4</span><span class=o>:</span><span class=s2>&#34;test&#34;</span><span class=o>:</span><span class=mi>2</span><span class=o>:</span><span class=p>{</span><span class=nx>S</span><span class=o>:</span><span class=mi>4</span><span class=o>:</span><span class=s2>&#34;</span><span class=se>\00</span><span class=s2>*</span><span class=se>\00\61</span><span class=s2>&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>3</span><span class=o>:</span><span class=s2>&#34;abc&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>7</span><span class=o>:</span><span class=s2>&#34;%00test%00b&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>3</span><span class=o>:</span><span class=s2>&#34;def&#34;</span><span class=p>;}</span>
</span></span></code></pre></div><h3 id=php71反序列化对类属性不敏感>PHP7.1+反序列化对类属性不敏感</h3><p>前面说了如果变量前是<strong>protected</strong>，序列化结果会在变量名前加上 <code>\x00*\x00</code>，但在特定版本**7.1以上(>=7.2)**则对于类属性不敏感，比如下面的例子 <code>name</code> 前面即使没有 <code>\x00*\x00</code> 也依然会输出 <code>ok</code>。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Test</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>protected</span> <span class=nv>$name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>name</span> <span class=o>=</span> <span class=s1>&#39;ok&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__destruct</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>unserialize</span><span class=p>(</span><span class=s1>&#39;O:4:&#34;Test&#34;:1:{s:4:&#34;name&#34;;s:2:&#34;ok&#34;;}&#39;</span><span class=p>);</span> <span class=c1>// ok
</span></span></span></code></pre></div><h3 id=绕过部分正则>绕过部分正则</h3><ol><li>利用加号绕过</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Test</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>name</span> <span class=o>=</span> <span class=s1>&#39;ok&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__destruct</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// O:4 替换为 O:+4
</span></span></span><span class=line><span class=cl><span class=nx>unserialize</span><span class=p>(</span><span class=s1>&#39;O:+4:&#34;Test&#34;:1:{s:4:&#34;name&#34;;s:2:&#34;ok&#34;;}&#39;</span><span class=p>);</span> <span class=c1>// ok
</span></span></span></code></pre></div><ol start=2><li>将对象包含在数组中</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Test</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=nv>$name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>name</span> <span class=o>=</span> <span class=s1>&#39;ok&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__destruct</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>unserialize</span><span class=p>(</span><span class=s1>&#39;a:1:{i:0;O:4:&#34;Test&#34;:1:{s:4:&#34;name&#34;;s:2:&#34;ok&#34;;}}&#39;</span><span class=p>);</span> <span class=c1>// ok
</span></span></span></code></pre></div><h2 id=0x06-限制>0x06 限制</h2><ul><li>PHP 7.0+ 可使用 <code>unserialize($data, ['allowed_classes' => ['User']])</code> 限制可反序列化的类。</li></ul><h2 id=0x07-工具>0x07 工具</h2><h3 id=phpggcphp通用小工具链><a href=https://github.com/ambionics/phpggc>PHPGGC：PHP通用小工具链</a></h3><p>该工具支持的 gadget 链包括：CodeIgniter4、Doctrine、Drupal7、Guzzle、Laravel、Magento、Monolog、Phalcon、Podio、Slim、SwiftMailer、Symfony、WordPress、Yii 和 ZendFramework</p><h2 id=0x08-反序列化漏洞>0x08 反序列化漏洞</h2><h3 id=介绍>介绍</h3><p>PHP 反序列化漏洞是一种常见的安全漏洞，当应用程序使用 <code>unserialize()</code> 函数处理用户可控的数据时，攻击者可能通过构造恶意的序列化字符串，在反序列化过程中触发危险操作（如执行任意代码、文件读写、SQL 注入等）。</p><p>反序列化漏洞出现得满足两个前提：</p><ol><li><p><code>unserialize</code> 的参数可控。</p></li><li><p>代码里有定义一个含有魔术方法的类，并且该方法里出现一些使用类成员变量作为参数的存在安全问题的函数。</p></li></ol><p>常见漏洞：</p><ul><li>反序列化RCE</li><li>Cookie反序列化身份伪造</li><li>反序列化任意文件读取</li><li>反序列化任意文件写入</li><li>反序列化信息泄露</li></ul><h3 id=利用链pop-chain>利用链（POP Chain）</h3><p>现代 PHP 应用通常不会在用户类中直接包含危险函数，但可以通过 <strong>属性控制 + 魔术方法 + 类继承/组合</strong> 构造“利用链”（Property-Oriented Programming, POP Chain）。</p><p>例如：</p><ul><li>找到一个类 A 的 <code>__destruct()</code> 调用了 <code>$this->obj->doSomething()</code></li><li>而类 B 的 <code>doSomething()</code> 会执行 <code>eval($this->data)</code></li><li>攻击者让 A 的 <code>$obj</code> 指向 B 实例，并控制 <code>$data</code></li></ul><p>这样即使没有直接危险函数，也能通过链式调用触发漏洞。</p></article><div class=page-right><aside class=page-right-toc><nav id=TableOfContents><ul><li><a href=#0x01-简介>0x01 简介</a><ul><li><a href=#1-序列化serialize>1. 序列化（serialize）</a></li><li><a href=#2-反序列化unserialize>2. 反序列化（unserialize）</a></li></ul></li><li><a href=#0x02-序列化格式>0x02 序列化格式</a></li><li><a href=#0x03-publicprivate与protect类型>0x03 public、private与protect类型</a><ul><li><a href=#public属性>public属性</a></li><li><a href=#private属性>private属性</a></li><li><a href=#protected属性>protected属性</a></li><li><a href=#序列化长度问题>序列化长度问题</a></li></ul></li><li><a href=#0x04-魔术方法>0x04 魔术方法</a><ul><li><a href=#简介>简介</a></li><li><a href=#__construct>__construct()</a></li><li><a href=#__destruct>__destruct()</a></li><li><a href=#__tostring>__toString()</a></li><li><a href=#__call>__call()</a></li><li><a href=#__callstatic>__callStatic()</a></li><li><a href=#__invoke>__invoke()</a></li><li><a href=#__wakeup>__wakeup()</a></li><li><a href=#__get>__get()</a></li><li><a href=#__set>__set()</a></li><li><a href=#__isset>__isset()</a></li><li><a href=#__unset>__unset()</a></li><li><a href=#__sleep>__sleep()</a></li></ul></li><li><a href=#0x05-绕过方法>0x05 绕过方法</a><ul><li><a href=#绕过__wakeupcve-2016-7124>绕过__wakeup(CVE-2016-7124)</a></li><li><a href=#引用绕过>引用绕过</a></li><li><a href=#16进制绕过字符的过滤>16进制绕过字符的过滤</a></li><li><a href=#php71反序列化对类属性不敏感>PHP7.1+反序列化对类属性不敏感</a></li><li><a href=#绕过部分正则>绕过部分正则</a></li></ul></li><li><a href=#0x06-限制>0x06 限制</a></li><li><a href=#0x07-工具>0x07 工具</a><ul><li><a href=#phpggcphp通用小工具链>PHPGGC：PHP通用小工具链</a></li></ul></li><li><a href=#0x08-反序列化漏洞>0x08 反序列化漏洞</a><ul><li><a href=#介绍>介绍</a></li><li><a href=#利用链pop-chain>利用链（POP Chain）</a></li></ul></li></ul></nav></aside></div></main><footer><p>© 2026 Wat4r's Blog</p></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js></script><script src=https://wat4r.github.io/js/code_header.js></script></body></html>